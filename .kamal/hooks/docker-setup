#!/bin/sh

echo "Setting up Docker on $KAMAL_HOSTS..."

# Update package list
apt-get -qq update >/dev/null

# Install prerequisites
DEBIAN_FRONTEND=noninteractive apt-get -y -qq install ca-certificates curl >/dev/null

# Add Docker's official GPG key
install -m 0755 -d /etc/apt/keyrings
curl -fsSL "https://download.docker.com/linux/ubuntu/gpg" -o /etc/apt/keyrings/docker.asc
chmod a+r /etc/apt/keyrings/docker.asc

# Add Docker repository
echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu focal stable" > /etc/apt/sources.list.d/docker.list

# Update package list again
apt-get -qq update >/dev/null

# Install Docker packages (without docker-model-plugin which doesn't exist)
DEBIAN_FRONTEND=noninteractive apt-get -y -qq install docker-ce docker-ce-cli containerd.io docker-compose-plugin docker-ce-rootless-extras docker-buildx-plugin >/dev/null

echo "Docker setup completed on $KAMAL_HOSTS"
