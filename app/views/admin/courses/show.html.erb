<h1 class="page-title"><%= @course.title %></h1>
<hr />

<div class="row pt-2">
  <div class="col-8 offset-2">
    <div class="d-flex justify-content-end">
      <%= link_to t('defaults.edit'),
                  [:edit, :admin, @course],
                  class: "btn btn-outline-warning btn-sm mr-2" %>
      <%= button_to t('defaults.destroy'),
                    [:admin, @course],
                    method: :delete,
                    data: {
                      controller: :confirm,
                      confirm_message_value: t('defaults.are_you_sure')
                    },
                    class: "btn btn-outline-danger btn-sm" %>
    </div>

    <p>
      <strong><%= Course.human_attribute_name(:title) %> :</strong>
      <%= @course.title %>
    </p>

    <p>
      <strong><%= Course.human_attribute_name(:description) %> :</strong>
      <%= @course.description %>
    </p>

    <p>
      <strong><%= Course.human_attribute_name(:capacity) %> :</strong>
      <%= @course.capacity %>
    </p>

    <p>
      <strong><%= Course.human_attribute_name(:availability) %> :</strong>
      <%= @course.availability%>
    </p>

    <p>
      <strong><%= Course.human_attribute_name(:category_id) %> :</strong>
      <%= @course.category.title %>
    </p>

    <p>
      <strong><%= Course.human_attribute_name(:weekday) %> :</strong>
      <%= @course.weekday %>
    </p>

    <hr />

    <div class="d-flex justify-content-between">
      <%= link_to t('defaults.back'), :back, class: "btn btn-link" %>

      <%= link_to t('.new_subscription', resource: Subscription.model_name.human.downcase), new_admin_subscription_path(course_ids: @course.id), class: "btn btn-primary" %>
    </div>

    <div class="row mt-4">
      <%= form_with url: [:admin, @course],
                local: true,
                method: :get,
                class: "col-sm-12 col-md-8 col-lg-6" do %>
        <div class= "d-flex align-items-center">
        <%= select_tag(
          :status,
          options_for_select(Subscription.statuses, params[:status]),
          include_blank: 'Statut',
          class: 'h-25 form-control mr-2'
        ) %>
        <%= select_tag(
          :year,
          options_for_select(
            (2019..Subscription.current_year).to_a.reverse,
            params[:year] || Subscription.current_year,
          ),
          include_blank: 'Année',
          class: 'h-25 form-control mr-2'
        ) %>
        <%= submit_tag("Filtrer", class: "btn btn-success") %>
      <% end %>
    </div>

    <div class="clearfix"></div>

    <%= turbo_frame_tag :course_subscriptions do %>
      <table class="table mt-4">
        <thead>
          <tr>
            <th>
              <%= link_to url_for(order: "subscriptions.id #{params[:order].in?([nil, 'subscriptions.id DESC']) ? 'ASC' : 'DESC'}") do %>
                <%= Subscription.model_name.human %>&nbsp;<%= params[:order].in?([nil, 'subscriptions.id DESC']) ? '⬇️' : '⬆️' %>
              <% end %>
            </th>

            <th>
              <%= link_to url_for(order: "members.first_name #{params[:order] == 'members.first_name DESC' ? 'ASC' : 'DESC'}") do %>
                <%= Member.human_attribute_name(:first_name) %>&nbsp;<%= params[:order] == 'members.first_name DESC' ? '⬇️' : '⬆️' %>
              <% end %>
              /
              <%= link_to url_for(order: "members.last_name #{params[:order] == 'members.last_name DESC' ? 'ASC' : 'DESC'}") do %>
                <%= Member.human_attribute_name(:last_name) %>&nbsp;<%= params[:order] == 'members.last_name DESC' ? '⬇️' : '⬆️' %>
              <% end %>
            </th>

            <th>
              <%= link_to url_for(order: "users.email #{params[:order] == 'users.email DESC' ? 'ASC' : 'DESC'}") do %>
                <%= User.human_attribute_name(:email) %>&nbsp;<%= params[:order] == 'users.email DESC' ? '⬇️' : '⬆️' %>
              <% end %>
            </th>

            <th><%= Subscription.human_attribute_name(:status) %></th>
            <th></th>
          </tr>
        </thead>

        <tbody>
          <% if @course.subscriptions
                      .filter_by_status(params[:status])
                      .where(year: params[:year] || Subscription.current_year)
                      .empty? %>
            <tr>
              <td colspan="9" class="text-center">
                <%= link_to t('.new_subscription'), new_admin_subscription_path, class: "btn btn-primary" %>
              </td>
            </tr>
          <% else %>
            <% @course.subscriptions
                      .joins(member: :user)
                      .filter_by_status(params[:status])
                      .where(year: params[:year] || Subscription.current_year)
                      .order(params[:order], created_at: :desc)
                      .includes(member: :user).each do |subscription| %>
              <tr class=<%= subscription.status_color %>>
                <td><%= link_to subscription.id , admin_subscription_path(subscription.id) %></td>
                <td>
                  <%= link_to admin_member_path(subscription.member_id) do %>
                    <%= subscription.member.full_name %>
                  <% end %>
                </td>
                <td><%= mail_to subscription.member.email, subscription.member.email %></td>
                <td><%= Subscription.human_attribute_name(subscription.status) %></td>
                <td>
                  <div class="dropdown mr-1">
                    <a type="button" class="dropdown-toggle" id="dropdownMenuOffset" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><%= t('defaults.action') %></a>
                    <div class="dropdown-menu" aria-labelledby="dropdownMenuOffset">
                      <%= link_to t('defaults.edit'),
                                  [:edit, :admin, subscription],
                                  class: "dropdown-item" %>

                      <%= button_to t('defaults.confirmed_bank_check'),
                                    {
                                      controller: 'admin/subscriptions',
                                      action: 'update',
                                      id: subscription.id,
                                      no_notification: true,
                                      subscription: { status: 'confirmed_bank_check' }
                                    },
                                    method: :put,
                                    class: "dropdown-item text-success" %>
                      <%= button_to t('defaults.confirmed_cash'),
                                    {
                                      controller: 'admin/subscriptions',
                                      action: 'update',
                                      id: subscription.id,
                                      no_notification: true,
                                      subscription: { status: 'confirmed_cash' }
                                    },
                                    method: :put,
                                    class: "dropdown-item text-info" %>
                      <%= button_to t('defaults.archive'),
                                    {
                                      controller: 'admin/subscriptions',
                                      action: 'update',
                                      id: subscription.id,
                                      no_notification: true,
                                      subscription: { status: 'archived' }
                                    },
                                    method: :put,
                                    class: "dropdown-item text-danger" %>

                      <%= button_to t('.remove_from_course'),
                                    unlink_course_admin_subscription_path(subscription.id, course_id: @course.id),
                                    method: :delete,
                                    data: {
                                      controller: :confirm,
                                      confirm_message_value: t(
                                        '.remove_from_course_are_you_sure',
                                        member_full_name: subscription.member.full_name, course_title: @course.title
                                      )
                                    },
                                    class: "dropdown-item text-danger" %>

                      <%= button_to t('defaults.destroy'),
                                    [:admin, subscription],
                                    method: :delete,
                                    data: {
                                      controller: :confirm,
                                      confirm_message_value: t('defaults.are_you_sure')
                                    },
                                    class: "dropdown-item text-danger" %>
                    </div>
                  </div>
                </td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    <% end %>
  </div>
</div>

