<%= form_for [:admin, @subscription],
              class: "mt-8 max-w-2xl mx-auto px-4",
              data: { controller: :form } do |f| %>
  <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-lg border border-gray-100 p-6 sm:p-8 space-y-6 sm:space-y-8 transition-all duration-200 hover:shadow-xl">
    <!-- Member Selection Section -->
    <div class="space-y-4">
      <div class="flex items-center space-x-3 mb-6">
        <div class="w-10 h-10 bg-gradient-to-br from-slate-600 to-slate-800 rounded-full flex items-center justify-center shadow-lg">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-gray-900"><%= t('.member') %></h3>
          <p class="text-sm text-gray-500"><%= t('.select_member_description') %></p>
        </div>
      </div>

      <div class="relative">
        <%= f.grouped_collection_select :member_id,
                                        User.all,
                                        :members,
                                        :email,
                                        :id,
                                        :full_name,
                                        { include_blank: t('.select_a_member') },
                                        class: "w-full bg-gray-50 border-2 border-gray-200 rounded-lg px-4 py-3 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-slate-600 focus:border-slate-600 transition-all duration-200 hover:border-gray-300 focus:-translate-y-1 focus:shadow-lg appearance-none cursor-pointer",
                                        required: true,
                                        data: {
                                          controller: 'select',
                                          placeholder: t('.select_a_member'),
                                          action: "change->form#submit"
                                        } %>
        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3">
          <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
      </div>

      <% if (f.object.errors[:member_id].any? || f.object.errors[:member].any?) && (f.object.courses.any? || f.object.camps_subscription.present?) %>
        <div class="rounded-lg bg-red-50 border border-red-200 p-4">
          <div class="flex items-center space-x-2">
            <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <h4 class="text-sm font-medium text-red-800"><%= t('.member_required') %></h4>
          </div>
          <ul class="mt-2 list-disc pl-5 text-sm text-red-700">
            <% f.object.errors.full_messages_for(:member_id).each do |message| %>
              <li><%= message %></li>
            <% end %>
            <% f.object.errors.full_messages_for(:member).each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>
    </div>

          <% if @subscription.member&.valid? %>
        <!-- Member's Current Year Subscriptions Info -->
        <% current_year_subscriptions = @subscription.member.subscriptions.where(year: Subscription.current_year) %>
        <% if current_year_subscriptions.any? %>
          <div class="rounded-lg bg-blue-50 border border-blue-200 p-4 mb-6">
            <div class="flex items-center space-x-2 mb-2">
              <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <h4 class="text-sm font-medium text-blue-800"><%= t('.current_year_subscriptions') %></h4>
            </div>
            <div class="text-sm text-blue-700">
              <% current_year_subscriptions.each do |subscription| %>
                <div class="mb-1">
                  â€¢ <%= subscription.description %>
                  <% if subscription.courses.any? %>
                    <span class="text-blue-600">(<%= subscription.courses.count %> <%= t('.courses_count', count: subscription.courses.count) %>)</span>
                  <% elsif subscription.camp.present? %>
                    <span class="text-blue-600">(<%= t('.camp') %>)</span>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- Parent Subscription Selection Section -->
        <% confirmed_subscriptions = @subscription.member&.subscriptions&.where(year: Subscription.current_year)&.confirmed&.where.not(id: @subscription.id) %>
        <% if confirmed_subscriptions&.any? %>
          <%= tag.div class: class_names("space-y-4", "animate-fade-in-up" => @subscription.parent_subscription.blank?) do %>
            <div class="flex items-center space-x-3 mb-4">
              <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-purple-600 rounded-full flex items-center justify-center shadow-md">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-gray-900"><%= t('.parent_subscription') %></h3>
                <p class="text-sm text-gray-500"><%= t('.parent_subscription_description') %></p>
              </div>
            </div>

            <div class="relative">
              <%= f.collection_select :parent_subscription_id,
                  confirmed_subscriptions,
                  :id,
                  :description,
                  { include_blank: t('.no_parent_subscription') },
                  class: "w-full bg-gray-50 border-2 border-gray-200 rounded-lg px-4 py-3 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-600 focus:border-purple-600 transition-all duration-200 hover:border-gray-300 focus:-translate-y-1 focus:shadow-lg appearance-none cursor-pointer",
                  data: { action: "change->form#submit" } %>
              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </div>
            </div>
          <% end %>
        <% end %>

      <!-- Tab Menu for Courses vs Camps -->
      <div class="space-y-4">
        <div class="flex items-center space-x-3 mb-4">
          <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center shadow-md">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-gray-900"><%= t('.subscription_type') %></h3>
            <p class="text-sm text-gray-500"><%= t('.subscription_type_description') %></p>
          </div>
        </div>

        <!-- Tab System -->
        <div>
          <!-- Tab Navigation -->
          <div class="border-b border-gray-200 pb-3">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
              <label class="cursor-pointer" for="courses">
                <span class="whitespace-nowrap py-3 px-3 border-b-2 border-transparent font-medium text-base text-gray-600 hover:text-slate-800 hover:border-slate-800 transition-colors duration-200">
                  <%= t('.courses') %>
                </span>
              </label>
              <% if @subscription.parent_subscription.present? %>
                <label class="cursor-pointer" for="camp">
                  <span class="whitespace-nowrap py-3 px-3 border-b-2 border-transparent font-medium text-base text-gray-600 hover:text-slate-800 hover:border-slate-800 transition-colors duration-200">
                    <%= t('.camp') %>
                  </span>
                </label>
              <% end %>
            </nav>
          </div>

          <!-- Tab Content -->
          <div class="mt-6">
            <input type="radio" name="subscription_type" value="courses" class="sr-only peer/courses" id="courses" checked>

            <!-- Courses Tab -->
            <div class="space-y-4 hidden peer-checked/courses:block">
              <div class="bg-gray-50 rounded-lg p-4 sm:p-6 space-y-3 border border-gray-100">
                <% if f.object.errors[:course_ids].any? || f.object.errors[:courses].any? %>
                  <div class="rounded-lg bg-red-50 border border-red-200 p-4 mb-4">
                    <div class="flex items-center space-x-2">
                      <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                      <h4 class="text-sm font-medium text-red-800"><%= t('.courses_required') %></h4>
                    </div>
                    <ul class="mt-2 list-disc pl-5 text-sm text-red-700">
                      <% f.object.errors.full_messages_for(:course_ids).each do |message| %>
                        <li><%= message %></li>
                      <% end %>
                      <% f.object.errors.full_messages_for(:courses).each do |message| %>
                        <li><%= message %></li>
                      <% end %>
                    </ul>
                  </div>
                <% end %>

                <%
                  # Filter courses based on member's existing subscriptions
                  available_courses = if @subscription.member
                    existing_course_ids = @subscription.member.subscriptions
                      .where(year: Subscription.current_year)
                      .joins(:courses)
                      .pluck(:course_id)
                    Course.active.where.not(id: existing_course_ids).order(:created_at)
                  else
                    Course.active.order(:created_at)
                  end
                %>
                <% if available_courses.any? %>
                  <%= f.collection_check_boxes :course_ids, available_courses, :id, :title do |b| %>
                    <div class="flex items-start space-x-3 group hover:bg-gray-100 rounded-lg p-2 transition-colors duration-200">
                      <div class="flex-shrink-0 mt-0.5">
                        <%= b.check_box(class: "h-5 w-5 text-slate-600 border-2 border-gray-300 rounded-md focus:ring-2 focus:ring-slate-600 focus:ring-offset-2 transition-all duration-200 appearance-none relative cursor-pointer checked:bg-gradient-to-r checked:from-slate-600 checked:to-slate-700 checked:border-transparent") %>
                      </div>
                      <div class="flex-1 min-w-0">
                        <%= b.label(class: "text-sm font-medium text-gray-900 cursor-pointer group-hover:text-slate-700 transition-colors duration-200") do %>
                          <%= b.text %>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                <% else %>
                  <div class="rounded-lg bg-yellow-50 border border-yellow-200 p-4 sm:p-6">
                    <div class="flex items-center space-x-3">
                      <svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                      </svg>
                      <div>
                        <h4 class="text-sm font-medium text-yellow-800"><%= t('.no_courses_available') %></h4>
                        <p class="text-sm text-yellow-700 mt-1"><%= t('.no_courses_available_description') %></p>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>

          <% if @subscription.parent_subscription.present? %>
            <input type="radio" name="subscription_type" value="camp" class="sr-only peer/camp" id="camp">

            <!-- Camp Tab -->
            <div class="space-y-4 hidden peer-checked/camp:block">
              <div class="bg-gray-50 rounded-lg p-4 sm:p-6 space-y-3 border border-gray-100">
              <% if f.object.errors[:camps_subscription].any? %>
                <div class="rounded-lg bg-red-50 border border-red-200 p-4 mb-4">
                  <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h4 class="text-sm font-medium text-red-800"><%= t('.camp_required') %></h4>
                  </div>
                  <ul class="mt-2 list-disc pl-5 text-sm text-red-700">
                    <% f.object.errors.full_messages_for(:camps_subscription).each do |message| %>
                      <li><%= message %></li>
                    <% end %>
                  </ul>
                </div>
              <% end %>

              <%= f.fields_for :camps_subscription, @subscription.build_camps_subscription do |cs| %>
                <%
                  # Filter camps based on member's existing subscriptions
                  available_camps = if @subscription.member
                    existing_camp_ids = @subscription.member.subscriptions
                      .where(year: Subscription.current_year)
                      .joins(:camp)
                      .pluck(:camp_id)
                    Camp.available.where.not(id: existing_camp_ids)
                  else
                    Camp.available
                  end
                %>
                <% if available_camps.any? %>
                  <div class="relative">
                    <%= cs.collection_select :camp_id,
                        available_camps,
                        :id,
                        :title,
                        { include_blank: t('.select_a_camp') },
                        class: "w-full bg-gray-50 border-2 border-gray-200 rounded-lg px-4 py-3 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition-all duration-200 hover:border-gray-300 focus:-translate-y-1 focus:shadow-lg appearance-none cursor-pointer" %>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3">
                      <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                      </svg>
                    </div>
                  </div>
                <% else %>
                  <div class="rounded-lg bg-yellow-50 border border-yellow-200 p-4 sm:p-6">
                    <div class="flex items-center space-x-3">
                      <svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                      </svg>
                      <div>
                        <h4 class="text-sm font-medium text-yellow-800"><%= t('.no_camps_available') %></h4>
                        <p class="text-sm text-yellow-700 mt-1"><%= t('.no_camps_available_description') %></p>
                      </div>
                    </div>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>
        </div>
      </div>
    <% end %>

    <!-- Action Buttons -->
    <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200">
      <%= link_to t('defaults.back'),
          %i[admin subscriptions],
          class: "inline-flex justify-center items-center px-6 py-3 border-2 border-gray-300 shadow-sm text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-600 transition-all duration-200 transform hover:scale-105 hover:-translate-y-1 hover:shadow-lg" %>

      <%= f.submit t('defaults.save'),
          class: "inline-flex justify-center items-center px-6 py-3 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-600 transition-all duration-200 transform hover:scale-105 hover:-translate-y-1 hover:shadow-lg",
          data: { form_target: :submit } %>
    </div>
  </div>
<% end %>



